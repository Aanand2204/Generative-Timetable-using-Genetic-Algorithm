{% extends "layout.html" %}

{% block content %}
<div class="container" style="max-width: 800px; margin: 2rem auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h2 style="color: var(--primary); margin: 0;">Generate Timetable</h2>
        <a href="{{ url_for('main.dashboard') }}" class="button"
            style="background-color: transparent; color: var(--text); border: 1px solid #d1d5db;">Back to Dashboard</a>
    </div>

    <div class="card">
        <form id="generateForm" onsubmit="event.preventDefault(); submitGeneration();">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                <div>
                    <label for="class_name">Class:</label>
                    <select id="class_name" name="class_name" required onchange="fetchSubjects()"
                        onkeydown="handleEnter(event, 'class')">
                        <option value="">Select Class</option>
                        {% for cls in classes %}
                        <option value="{{ cls.class_name }}">{{ cls.class_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="semester">Semester:</label>
                    <input type="number" id="semester" name="semester" required min="1" max="8"
                        onchange="fetchSubjects()" onkeydown="handleEnter(event, 'semester')">
                </div>
            </div>

            <div id="subjectsSection" style="display: none;">
                <h3 style="margin-bottom: 1rem; font-size: 1.1rem; color: #374151;">Set Priorities</h3>
                <p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 1rem;">Higher number = Higher priority <span
                        id="priorityRangeLabel">(1-5)</span>
                </p>

                <div id="subjectsList" style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                    <!-- Filled by JS -->
                </div>

                <div class="actions">
                    <button type="button" onclick="submitGeneration()" class="w-full">Generate Timetable</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    async function fetchSubjects() {
        const className = document.getElementById('class_name').value;
        const semester = document.getElementById('semester').value;
        const list = document.getElementById('subjectsList');
        const section = document.getElementById('subjectsSection');

        if (!className || !semester) {
            section.style.display = 'none';
            return;
        }

        try {
            const response = await fetch(`/subjects?class_name=${className}&semester=${semester}`);
            const subjects = await response.json();

            list.innerHTML = '';
            if (subjects.length > 0) {
                subjects.forEach(sub => {
                    const div = document.createElement('div');
                    div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem;';

                    div.innerHTML = `
                    <span style="font-weight: 500;">${sub}</span>
                    <input type="number" class="priority-input" data-subject="${sub}" value="1" min="1" max="${subjects.length}" style="width: 80px;" onkeydown="handlePriorityEnter(event)">
                `;
                    list.appendChild(div);
                });
                section.style.display = 'block';
                const label = document.getElementById('priorityRangeLabel');
                if (label) {
                    label.innerText = `(1-${subjects.length})`;
                }
            } else {
                section.style.display = 'none';
            }
        } catch (e) {
            console.error('Error fetching subjects:', e);
        }
    }

    async function handleEnter(event, type) {
        if (event.key === 'Enter') {
            event.preventDefault();
            if (type === 'class') {
                document.getElementById('semester').focus();
            } else if (type === 'semester') {
                await fetchSubjects();
                // Wait a tick for the DOM to update
                setTimeout(() => {
                    const firstPriorityInput = document.querySelector('.priority-input');
                    if (firstPriorityInput) {
                        firstPriorityInput.focus();
                        firstPriorityInput.select();
                    }
                }, 0);
            }
        }
    }

    function handlePriorityEnter(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            const inputs = Array.from(document.querySelectorAll('.priority-input'));
            const index = inputs.indexOf(event.target);
            if (index > -1 && index < inputs.length - 1) {
                inputs[index + 1].focus();
                inputs[index + 1].select();
            } else {
                // Optional: Submit if it's the last one, or just do nothing
                submitGeneration();
            }
        }
    }

    async function submitGeneration() {
        const className = document.getElementById('class_name').value;
        const semester = document.getElementById('semester').value;
        const priorityInputs = document.querySelectorAll('.priority-input');

        if (!className || !semester) {
            alert("Please select Class and Semester first.");
            return;
        }

        if (priorityInputs.length === 0) {
            alert("Please wait for subjects to load and set priorities before generating.");
            fetchSubjects(); // Try fetching again if missing
            return;
        }

        const priorities = {};
        const credits = {}; // We will let backend fetch credits from DB, but we need to pass empty or overrides?
        // Let's rely on backend fetching credits.

        priorityInputs.forEach(input => {
            priorities[input.dataset.subject] = parseInt(input.value);
        });

        try {
            const response = await fetch('/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    class_name: className,
                    semester: semester,
                    priorities: priorities,
                    credits: {} // Empty, backend should fetch from DB
                })
            });

            const result = await response.json();
            if (result.redirect) {
                window.location.href = result.redirect;
            } else if (result.success) {
                // Fallback if success is used
                window.location.href = result.redirect || '/final_timetable';
            } else {
                alert(result.error || 'Generation failed');
            }
        } catch (e) {
            alert('An error occurred');
        }
    }
    window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const className = urlParams.get('class_name');
        const semester = urlParams.get('semester');

        if (className && semester) {
            const classSelect = document.getElementById('class_name');
            const semesterInput = document.getElementById('semester');

            if (classSelect && semesterInput) {
                classSelect.value = className;
                semesterInput.value = semester;
                fetchSubjects();
            }
        }
    };
</script>
{% endblock %}